---
title: "DataAnalysis"
author: "Aadish Chopra"
date: "7/1/2019"
output: html_document
code_folding: hide
---


# Changing r_chunks global settings 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width = 10)


```

Sourcing the boostrap file and change the global paramters


```{r loadbootstrap}
suppressMessages(source('bootstrap.R'))
suppressMessages(source('helperfunctions.R'))
```

# Exploratory data analysis


```{r dimension analysis}
dim(AirBNB)
dim(ZillowData)

```

We see that AirBNB has 95 dimensions with 40753 observations and Zillow has 262 dimensions with 8946 observations.


##Exploring AIRBNB data

Let's us look at the data first. The metadata is also available in the docx document

```{r viewdata ,eval=FALSE,echo=FALSE}

# Looking at the first 90 columns 
out_table <- cbind(names(AirBNB)[1:30],names(AirBNB)[31:60],names(AirBNB)[61:90])
htmlTable(out_table,
          cgroup = c("Set 1:30", "Set 31:60","Set 61:90"),
          n.cgroup = c(3),
          rnames = FALSE)


```


Data type read from csv while loading
Reading a single row to understand the dataset

Price and other columns associated with money are listed in dollars. For example $50. In order to do analysis we will be stripping the dollar sign off of the entire column 


```{r columntypes}

#stripping the dollar sign off


#identify which columns needs stripping
remove_dollar<-strip_money(pattern = 'price',dataset = AirBNB)

#manually inspecting
#colnames(AirBNB[AirBNB %>% str_detect(pattern = '\\$')])
additional_columns<-c('security_deposit','cleaning_fee','extra_people')

remove_dollar<-c(remove_dollar,additional_columns)
#strip dollar amount from these columns
AirBNB[,remove_dollar]<-apply(AirBNB[,remove_dollar],2,FUN = remove_sign,money = "\\$")

# convert characters to numeric columns

AirBNB[,remove_dollar]<-apply(AirBNB[,remove_dollar],2, FUN =as.numeric)  


unique(lapply(AirBNB,class))



```

4 types of data were read : integer, character, numeric, logical 

Since we loaded the data with the option string as Factors =FALSE. We will have to do some data manipulation to understand the right data type 


URL columns would not be useful therefore removing these columns 

```{r removeurlcolumns}
AirBNB<-removethesecolumns(pattern_remove = "url",dataset = AirBNB)
AirBNB<-removethesecolumns(pattern_remove = "scrape",dataset = AirBNB)

```


What columns have NA values 


```{r NAs}

how_many_NA<-as.data.frame(unlist(apply(AirBNB, 2, noofNA)))
kable(x = how_many_NA ,caption = "Missing value analysis")
AirBNB<-AirBNB %>% select(-c('license','has_availability'))

```

Since we will be matching on location ,let us check the data integrity of zipcodes and latitude and longitude

1) zipcode should be of length 5
2) There are 618 rows which have improper length zipcodes. 

We can use latitudes and longtitudes for those locations and compare it with others but we will deal with it later


```{r}

sum(str_count(AirBNB$zipcode,pattern = "[0-9]")==5)
nrow(AirBNB)-sum(str_count(AirBNB$zipcode,pattern = "[0-9]")==5)

```


We see that there are 2 columns which have no values at all. We can delete those columns. 
As a rule of thumb we can safely remove columns which have missing values in ~[80]% of the rows


There are columns which are disseminating no information. Let us analyze columns for unique values

```{r delete_no_information}

apply(AirBNB,2,analyze_distinct_values)
AirBNB<-AirBNB %>% select(-c('requires_license','experiences_offered'))

```

From distinct value analysis we see that requires_license and experiences_offered have no information at all 


The consultancy company has already identified that 2 bedroom properties are the most profitable. 

Bedrooms is the variable we are filtering on for now, although later in the analysis we will try to include bedrooms of size 0 

```{r filter_2_rooms}

no_of_bedrooms<-2
f_city<-'New York'
two_room_property<-AirBNB %>% filter(AirBNB$bedrooms ==no_of_bedrooms & city==f_city)

how_many_NA_2_bedrooms<-as.data.frame(unlist(apply(two_room_property,MARGIN =  2, noofNA)))


two_room_property %>% select(zipcode,price) %>% filter(zipcode>0)%>% group_by(zipcode)%>% summarise(avg_price=mean(price,na.rm = T),count=n()) %>%arrange(desc(count),desc(avg_price))%>%mutate_if(is.numeric,round,digits=0)%>% top_n(n = 25)%>% ggplot(.,mapping = aes(zipcode,avg_price))+geom_bar(stat = "identity")





```


62 properties have blank or no zipcodes. 

Clustering can be done using latitude or longitude. We will deal with this later


###Identify which areas are good

```{r visualizations,fig.width=10,echo=FALSE }

two_room_property %>% select(zipcode,price) %>% filter(zipcode>0)%>% group_by(zipcode)%>% summarise(n_count=n()) %>% arrange(desc(n_count))%>% top_n(n = 25)%>%
ggplot(data = .,mapping = aes(zipcode,n_count,group=1))+geom_line(stat = 'identity')+geom_hline(yintercept = 100,linetype='dashed',color='red')    


two_room_property %>% select(zipcode,price) %>% filter(zipcode>0)%>% group_by(zipcode)%>% summarise(avg_price=median(price,na.rm = T),count=n()) %>%arrange(desc(count),desc(avg_price))%>%mutate_if(is.numeric,round,digits=0)%>% top_n(n = 25)%>% ggplot(.,mapping = aes(zipcode,avg_price))+geom_bar(stat = "identity")


  
```







```{r mergeanalysis}

m_air_zil<-merge(two_room_property,Z_NY,by = 'zipcode',suffixes = c('air','zil'))



calculate_profits<-function(market,property){}
```



Just one property in NJ , rest all of the properties are in NY. 













# Analyzing Zillow data set

Filtering for new york City
```{r analyze_zillow}

Z_NY<-ZillowData %>% filter(City=="New York") %>%
select(-c(RegionID,City,State,Metro,CountyName,SizeRank))

# rename region name to zipcode for merging

colnames(Z_NY[1])<-"zipcode"

# taking the latest price as the price. to be changed in future

tmydf = setNames(data.frame(t(Z_NY[,-1])), Z_NY[,1])
tmydf$ds=seq.Date(from = as.Date('1996/04/01'),to = as.Date('2017/06/01'),by = 'month')


temp<-apply(tmydf,2,cbind.data.frame,tmydf['ds'])

temp1<-lapply(temp, setNames,c('y','ds'))

lapply(temp1, prophet)





```








If time permits I would like to check which kind of property is most suitable

```{r bedrooms}
class(AirBNB$bedrooms)
# let us see the distribution of the variable
table(AirBNB$bedrooms)
percentage_missing<-(sum(is.na(AirBNB$bedrooms))/nrow(AirBNB))*100

zero_bedrooms<-AirBNB[AirBNB$bedrooms==0,]


```

We observer two things 

1) 69 missing values or 0.17%
2) frequency distribution shows that there are 3525 properties which are having 0 bedrooms.
We will have to investigate this as to what kind of properties are they.


We will only look at those properties which are 2 bedrooms

Since 0 bedrooms can be a field which the user didn't enter or can be bad data


#Fixing bedrooms with zero length 



```{r fix_0_bedrooms}

ggplot(data = zero_bedrooms,mapping=aes(zero_bedrooms$beds,fill=zero_bedrooms$property_type))+
geom_histogram()+
scale_x_continuous(breaks = zero_bedrooms$beds)

  
```

Most of the data is for 1,2 and 3 beds

```{r price_analysis,eval=TRUE,echo=FALSE}


# p<-ggplot(data=zero_bedrooms %>% filter(beds<4),mapping = aes(zero_bedrooms$price))+
# geom_histogram(stat = 'count')

# p+facet_grid(vars(beds))

```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
