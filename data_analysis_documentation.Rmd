---
title: "AirBNB Zillow Data Challenge Document for Capital One"
author: "Aadish Chopra"
date: "7/8/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width = 10,warning = FALSE,message = FALSE)
options(scipen=99999)

```


# Assumptions

1. Occupancy rate has been assumed to be constant throughout the year irrespective of the fact that it can change due to       holidays
2. Review score rating has been used to adjudicate the occupancy rate since it is Overall score given based on 
   + accuracy, 
   + cleanliness, 
   + check-in, 
   + communication, 
   + location, 
   + and value. 
3. Cost of property has been calculated using forecasting using the Zillow Data set. Extraneous variables which can affect     the cost of the property have been ignored.
4. Graphs and plots have been plotted majorly by removing missing values 
5. Mean and median prices have been taken to calculate the profit-loss 


Installing the required packages and loading the dataset from source

<span style="color:red">To reproduce this rmarkdown create a data folder in the working directory</span>


```{r loadbootstrap,warning=FALSE,message=FALSE,echo=TRUE,results='hide'}
# data is assumed to be locally available 

# otherwise we can clone the repository and then do a pull 
# Load all the libraries 

required_packages<-c('knitr','dplyr','htmlTable','stringr','ggplot2','prophet','gridExtra','scales','mice')
load_required_packages<-function(required_packages){
  if(!require(required_packages,character.only = TRUE))
  {
    install.packages(required_packages)
    require(required_packages,character.only = TRUE)
  }
  else
  {
    require(required_packages,character.only = TRUE)
  }
}

lapply(required_packages,load_required_packages )

# Import the dataset
if(!file.exists('data/listings.csv'))
{
  listing_tar<-download.file(url="http://data.insideairbnb.com/united-states/ny/new-york-city/2017-05-02/data/listings.csv.gz",destfile = "data/listings.csv.gz")
  untar(tarfile = 'data/listings.csv.gz',exdir = 'data')  
}

if(!file.exists('data/Zip_Zhvi_2bedroom.csv')){
untar(tarfile = 'data/Zip_Zhvi_2bedroom.csv.zip',exdir = 'data')
}

AirBNB<-read.csv(file = "data/listings.csv",header = T,sep = ",",stringsAsFactors = F)
ZillowData<-read.csv("data/Zip_Zhvi_2bedroom.csv",header = T,sep = ",",stringsAsFactors = F)


```

These are helper functions which ideally should be in a separate R file and sourced into code.



```{r load_helper_functions}
removethesecolumns<-function(pattern_remove,dataset)
{
  
  message(" removing column ")
  message(grep(pattern = pattern_remove,x = names(dataset),value = T))
  dataset %>% select(-contains(pattern_remove,ignore.case = TRUE))
}

analyze_distinct_values<-function(column)
{
  length(unique(column))
}

strip_money<-function(dataset,pattern){
  colnames(dataset[grep(pattern,colnames(dataset))])
}

remove_sign<-function(money,column)
{
  gsub(money,replacement = '',x =column )
}

noofNA<-function(column)
  {
  
  if(sum(is.na(column))>0)
  {
    sum(is.na(column))
  }
}


Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}


```




# Exploratory data analysis


```{r dimension analysis}
kable(x=dim(AirBNB),col.names = "Dimensions Airbnb",rownames= c('observations','columns'))
kable(x=dim(ZillowData),col.names = "Dimensions Zillow",rownames= c('observations','columns'))

```

We see that AirBNB has 95 dimensions with 40753 observations and Zillow has 262 dimensions with 8946 observations.


# Analyzing Zillow data set

Filtering for new york City

```{r analyze_zillow,warning=FALSE,message=FALSE}

Z_NY<-ZillowData %>% filter(City=="New York") %>%
select(-c(RegionID,City,State,Metro,CountyName,SizeRank))
colnames(Z_NY)[1]<-"zipcode"
trans_zil = setNames(data.frame(t(Z_NY[,-1])), Z_NY[,1])
present<-data.frame(ds=seq.Date(from = as.Date('1996/04/01'),to = as.Date('2017/06/01'),by = 'month'))

# Predicting prices till Aug 2019
future<-data.frame(ds=seq.Date(from = as.Date('1996/04/01'),to = as.Date('2019/08/01'),by = 'month'))
bind_for_prophet<-apply(trans_zil,2,cbind.data.frame,present)
bind_for_prophet<-lapply(bind_for_prophet, setNames,c('y','ds'))
make_model<-lapply(bind_for_prophet, prophet)
forecast<-lapply(make_model, predict,future)
extract_yhat<-lapply(forecast, function(x) x[, 'yhat'][nrow(future)])

# Set predicted price in original data frame 
Z_NY$predicted_price<-unlist(extract_yhat)






# select items for merging 

cols<-c('zipcode','X2017.06','predicted_price')
Z_NY_predicted<-Z_NY[,cols]
Z_NY_predicted$zipcode<-as.factor(Z_NY_predicted$zipcode)



```


Price trend of zipcode **10025 **


```{r}
dyplot.prophet(make_model$`10025`,forecast$`10025`)

```






## Exploring AIRBNB data

Let's us look at the data first. The metadata is also available in the docx document

```{r viewdata ,eval=FALSE,echo=FALSE}

# Looking at the first 90 columns 
out_table <- cbind(names(AirBNB)[1:30],names(AirBNB)[31:60],names(AirBNB)[61:90])
htmlTable(out_table,
          cgroup = c("Set 1:30", "Set 31:60","Set 61:90"),
          n.cgroup = c(3),
          rnames = FALSE)


```



Price and other columns associated with money are listed in dollars. For example $50. In order to do analysis we will be stripping the dollar sign off of the entire column 


```{r columntypes,warning=FALSE,message=FALSE}

#stripping the dollar sign off


#identify which columns needs stripping
remove_dollar<-strip_money(pattern = 'price',dataset = AirBNB)
additional_columns<-c('security_deposit','cleaning_fee','extra_people')

remove_dollar<-c(remove_dollar,additional_columns)
#strip dollar amount from these columns
AirBNB[,remove_dollar]<-apply(AirBNB[,remove_dollar],2,FUN = remove_sign,money = "\\$")

# convert characters to numeric columns

AirBNB[,remove_dollar]<-apply(AirBNB[,remove_dollar],2, FUN =as.numeric)  


```


Since we loaded the data with the option string as Factors =FALSE. We will have to do some data manipulation to understand the right data type 


URL columns would not be useful therefore removing these columns 

```{r removeurlcolumns}
AirBNB<-removethesecolumns(pattern_remove = "url",dataset = AirBNB)
AirBNB<-removethesecolumns(pattern_remove = "scrape",dataset = AirBNB)
AirBNB<-AirBNB %>% select(-c('license','has_availability'))

```


What columns have missing values 
We see that there are 2 columns which have no values at all. We can delete those columns. 
As a rule of thumb we can safely remove columns which have missing values in ~[80]% of the rows

Missing value analysis


```{r NAs}

how_many_NA<-data.frame('missing values'=sort(unlist(apply(AirBNB, 2, noofNA)),decreasing = T))
kable(x = how_many_NA ,caption = "Missing value analysis")

```



Distribution of bedrooms variable within 


```{r}
# let us see the distribution of the bedrooms variable 
barplot(table(AirBNB$bedrooms),col = "blue")

```




Since we will be matching on location ,let us check the data integrity of zipcodes and latitude and longitude
1. 69 missing values or 0.17%
2. frequency distribution shows that there are 3525 properties which are having 0 bedrooms.
We will have to investigate this as to what kind of properties are they.



1) zipcode should be of length 5


```{r}

sum(str_count(AirBNB$zipcode,pattern = "[0-9]")==5)
nrow(AirBNB)-sum(str_count(AirBNB$zipcode,pattern = "[0-9]")==5)

```

There are columns which are disseminating no information. Let us analyze columns for unique values

```{r delete_no_information}

kable(x=sort(apply(AirBNB,2,analyze_distinct_values),decreasing = T),col.names = 'Distinct Values')
AirBNB<-AirBNB %>% select(-c('requires_license','experiences_offered'))


```

From distinct value analysis we see that requires_license and experiences_offered have no information at all 
The consultancy company has already identified that 2 bedroom properties are the most profitable. 

<span style="color:red">Set **no_of_bedrooms** of here</span>

```{r filter_2_rooms}
# set variable here in case the consulting company needs to do analysis on other properties
no_of_bedrooms=2
air_two_room_property<-AirBNB %>% filter(AirBNB$bedrooms ==no_of_bedrooms)
how_many_NA_2_bedrooms<-data.frame(MissingValues=sort(unlist(apply(air_two_room_property,MARGIN =  2, noofNA)),decreasing = T))

kable(how_many_NA_2_bedrooms,caption = "Missing values in the filtered data set")

```



```{r merging_by_zipcode}
two_room_property<-merge(air_two_room_property,Z_NY_predicted,by = 'zipcode',suffixes = c('air','zil'))
two_room_property$neighbourhood_group_cleansed<-as.factor(two_room_property$neighbourhood_group_cleansed)

```


### Visualizations of the properties versus price and other parameters



```{r visualizations,fig.width=10,echo=FALSE,message=FALSE,warning=FALSE }

two_room_property<-merge(air_two_room_property,Z_NY_predicted,by = 'zipcode',suffixes = c('air','zil'))
theme_set(theme_bw())

two_room_property %>% select(zipcode,price) %>% filter(zipcode>0)%>% group_by(zipcode)%>% summarise(n_count=n()) %>% arrange(desc(n_count))%>% top_n(n = 25)%>%
ggplot(data = .,mapping = aes(reorder(zipcode,-n_count),n_count,group=1))+geom_line(stat = 'identity')+geom_hline(yintercept = 70,linetype='dashed',color='red')+ggtitle("Count of properties plotted against zipcode")+xlab('zipcode')+ylab('count')  

# boxplot to show variations in price within a zipcode


ggplot(data=two_room_property,mapping = aes(zipcode,price))+
geom_boxplot(outlier.colour = "red",varwidth = TRUE)+ggtitle("Variation of price within a zipcode")


two_room_property %>% select(zipcode,price) %>% filter(zipcode>0)%>% group_by(zipcode)%>% summarise(avg_price=mean(price,na.rm = T),count=n()) %>%arrange(desc(avg_price),count)%>%mutate_if(is.numeric,round,digits=0)%>% top_n(n = 25)%>% ggplot(.,mapping = aes(reorder(zipcode,-avg_price),avg_price))+geom_bar(stat = "identity")+ggtitle("Plot of average AIRBNB price against zipcode")+xlab('zipcode')


two_room_property %>% select(zipcode,price) %>% filter(zipcode>0)%>% group_by(zipcode)%>% summarise(median_price=median(price,na.rm = T),count=n()) %>%arrange(desc(median_price),desc(count))%>%mutate_if(is.numeric,round,digits=0)%>% top_n(n = 25)%>% ggplot(.,mapping = aes(reorder(zipcode,-median_price),median_price))+geom_bar(stat = "identity",mapping = aes(fill="blue"))+ggtitle("Plot of median AIRBNB price against zipcode")+xlab("zipcode")

# In which neighborhood these properties are located 

two_room_property %>% group_by(neighbourhood_group_cleansed) %>% summarise(avg_price=mean(price,na.rm = T)) %>% arrange(desc(avg_price)) %>% select(neighbourhood_group_cleansed,avg_price)%>% ggplot(.,mapping = aes(neighbourhood_group_cleansed,avg_price,fill=neighbourhood_group_cleansed))+geom_bar(stat='identity')+xlab("neighbourhood")+ggtitle("Variation of price within the neighborhood")

# which zipcodes are located in which location 

ggplot(data=two_room_property,mapping=aes(zipcode,fill=neighbourhood_group_cleansed))+
geom_histogram(stat='count')+facet_grid(neighbourhood_group_cleansed~.)  
 


p1<-ggplot(data = Z_NY_predicted,mapping = aes(x=reorder(zipcode,-predicted_price),y=predicted_price))+
geom_bar(stat='identity')+ggtitle("Decreasing predicted price plotted against zipcode")+xlab("zipcode")


p2<-ggplot(data = Z_NY_predicted,mapping = aes(x=reorder(zipcode,-X2017.06),y=X2017.06))+
geom_bar(stat='identity')+ggtitle("Decreasing actual price plotted against zipcode")+xlab("zipcode")+ylab("June 2017")

grid.arrange(arrangeGrob(p1, p2))
  
```

#What properties to invest in ?

Time Period has been taken to be a year which is equivalent of multiplying 30 days in a month and 12 months

```{r mergeanalysis}


two_room_property$occupancy_score=two_room_property$review_scores_rating
kable(data.frame(occupancy_score=c('75-100','50-75','25-50','0-25'),occupancy_rate=c('75%','65%','55%','45%')),caption = "Occupancy rate based on review score and number of reviews")

two_room_property$occupancy_rate<-cut(two_room_property$occupancy_score, 
                    breaks = c(0,25,50,75,100), 
                    labels = c(".45", ".55", ".65", ".75"), 
                    right = TRUE)
two_room_property$occupancy_rate=as.numeric(as.character(two_room_property$occupancy_rate))

# variable parameters
days=30
months=12
timePeriod=days*months
Cost_Price='X2017.06'
Sell_Price='price'
Occupancy_rate='occupancy_rate'

two_room_property$breakeven_years=two_room_property[,Cost_Price]/(two_room_property[,Sell_Price]*two_room_property[,Occupancy_rate]*timePeriod)


# profit-loss matrix by taking averages across the zipcodes

ROI_mean<-two_room_property %>% group_by(zipcode) %>% summarise(avg_return_in_years=mean(breakeven_years,na.rm = T),avg_airbnb_price=mean(price,na.rm = T),avg_cost_price=mean(X2017.06,na.rm = T),count=n()) %>% arrange((avg_return_in_years))


kable(ROI_mean,caption = "ROI using the mean price in years")
 
# profit-loss matrix by taking median across the zipcodes

ROI_median<-two_room_property %>% group_by(zipcode) %>% summarise(median_return_in_years=median(breakeven_years,na.rm = T),median_airbnb_price=median(price,na.rm = T),median_cost_price=median(X2017.06,na.rm = T),count=n()) %>% arrange((median_return_in_years))


kable(ROI_median,caption = "ROI using the median price in years")

```

Filtering out properties having count less than 50

```{r atleast50count}

ROI_mean<-ROI_mean %>% filter(count >50)
ROI_median<-ROI_mean %>% filter(count >50)

```



Visualing the ROI against the zipcodes


```{r}

ggplot(ROI_mean,mapping = aes(x=zipcode,y=avg_return_in_years))+
geom_bar(mapping = aes(reorder(zipcode,avg_return_in_years)),stat='identity',fill="green")+
ggtitle("Breakeven analysis taking the mean price ")  



ggplot(ROI_median,mapping = aes(x=zipcode,y=avg_return_in_years))+
geom_bar(mapping = aes(reorder(zipcode,avg_return_in_years)),stat='identity',fill="orange")+
ggtitle("Breakeven analysis taking the median price ")  


```



# Conclusion 

The ROI is less for some zipcodes but there are not many properties. We atleast need a few properties to be able to make a firm decision.  


# Future Steps

1. Properties other than 2 bedrooms should be looked at. Since there are over 35,000 observations it is a       rich data set
2. Factors such as transportation, proximity to work location can be used to map the area for long-term         rentals
3. Since we only have data for short-term rentals, it would be a good opportunity to look at the prospect of    a profit in long term rentals especially New-York being the financial capital
4. Analysis of property based on the property type 
   + Apartment
   + House
   + Condo
5. There are 618 rows which have improper length zipcodes. These can be imputed using the latitude and          longitudes


